<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>中医症状选择与辨证示意</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --accent: #0077b6;
      --accent-soft: rgba(0, 119, 182, 0.08);
      --danger: #b00020;
      --text-main: #222222;
      --text-secondary: #555555;
      --tag-bg: #f0f0f3;
      --tag-selected-bg: #0077b6;
      --tag-selected-text: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei",
        sans-serif;
      background: radial-gradient(circle at top, #ffffff, var(--bg));
      color: var(--text-main);
      display: flex;
      flex-direction: row;
      gap: 16px;
      min-height: 100vh;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
      padding: 16px 18px;
    }

    .body-wrapper {
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .right-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    h1 {
      font-size: 1.15rem;
      margin: 0 0 4px;
    }

    h2 {
      font-size: 1rem;
      margin: 0 0 8px;
    }

    .body-region-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }

    .region-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #fafafa;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s ease;
    }

    .region-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    svg {
      width: 100%;
      max-width: 380px;
      min-width: 260px;
      height: auto;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 12px;
      background: radial-gradient(circle at 50% 0%, #fdfdfd, #f3f3f3);
    }

    .symptom-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .symptom-tag {
      font-size: 0.82rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tag-bg);
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
      transition: all 0.12s ease;
      white-space: nowrap;
    }

    .symptom-tag.selected {
      border-color: var(--accent);
      background: var(--tag-selected-bg);
      color: var(--tag-selected-text);
      font-weight: 500;
    }

    .summary-box {
      font-size: 0.86rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .summary-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-item {
      margin-bottom: 2px;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease,
        transform 0.06s ease;
      box-shadow: 0 4px 10px rgba(0, 119, 182, 0.25);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 119, 182, 0.25);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
    }

    .result-box {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--text-main);
    }

    .result-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-section {
      margin-top: 4px;
    }

    .result-label {
      font-weight: 600;
    }

    .result-warning {
      margin-top: 6px;
      color: var(--danger);
    }

    .ai-note {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #ddd;
      font-size: 0.88rem;
      color: #333333;
    }

    .ai-error {
      margin-top: 4px;
      color: var(--danger);
      font-size: 0.85rem;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
      }

      .body-wrapper {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="body-wrapper card">
    <h1>部位选择</h1>
    <div class="body-region-buttons" id="regionButtons"></div>

    <!-- 人形简化示意图，可点击不同部位（目前点击逻辑在按钮上，图只是展示） -->
    <svg viewBox="0 0 200 400" aria-label="人体平面示意图">
      <!-- 头 -->
      <circle cx="100" cy="50" r="25" fill="#fdfdfd" stroke="#ccc" />
      <!-- 躯干 -->
      <rect x="75" y="80" width="50" height="100" rx="20" fill="#fdfdfd" stroke="#ccc" />
      <!-- 手臂 -->
      <rect x="45" y="90" width="25" height="90" rx="12" fill="#fdfdfd" stroke="#ccc" />
      <rect x="130" y="90" width="25" height="90" rx="12" fill="#fdfdfd" stroke="#ccc" />
      <!-- 骨盆/下腹 -->
      <rect x="80" y="180" width="40" height="40" rx="16" fill="#fdfdfd" stroke="#ccc" />
      <!-- 双腿 -->
      <rect x="80" y="220" width="16" height="80" rx="10" fill="#fdfdfd" stroke="#ccc" />
      <rect x="104" y="220" width="16" height="80" rx="10" fill="#fdfdfd" stroke="#ccc" />
    </svg>
    <div class="hint">
      提示：上面的人形图仅作示意，实际部位选择请使用上方按钮。
    </div>
  </div>

  <div class="right-wrapper">
    <div class="card">
      <h1>症状多选（按部位）</h1>
      <div id="currentRegionTitle" style="font-size:0.92rem;margin-bottom:4px;">
        当前部位：
      </div>
      <div id="symptomList">
        <!-- 动态填充 -->
      </div>

      <div class="summary-box" style="margin-top:10px;">
        <div class="summary-title">当前已选择症状：</div>
        <div id="selectedSummary">暂未选择任何症状。</div>
      </div>

      <button id="analyzeBtn" class="btn-primary">
        生成辨证建议（从后端）
      </button>
      <div class="hint">
        温馨提示：此工具仅用于中医理论学习和示意，不用于真实诊断或处方。
      </div>
    </div>

    <div class="card">
      <h2>辨证结果示意</h2>
      <div id="analysisResult" class="result-box">
        请选择多个症状后，点击“生成辨证建议”查看示意性分析。
      </div>
    </div>
  </div>

  <script>
    // ===== 1. 配置：后端 API 地址（你自己改成实际域名） =====
    // 比如：const API_URL = "https://tcmai-api-git-main-longposts-projects.vercel.app/api/analyze";
    const API_URL = "https://tcmai-api.vercel.app/api/analyze"; // 占位，你自己改

    // ===== 2. 前端定义各部位及常用症状（名称要尽量和后端 TCM_SYMPTOM_FEATURES 对上） =====
    const BODY_REGIONS = {
      head: {
        key: "head",
        label: "头部",
        symptoms: ["头晕", "头痛", "偏头痛", "头重如裹", "眩晕", "耳鸣", "失眠", "多梦"]
      },
      chest: {
        key: "chest",
        label: "胸部 / 心肺",
        symptoms: ["胸闷", "心悸", "气短懒言", "咳嗽", "痰多", "痰黄黏", "痰白清稀", "胸痛"]
      },
      upperAbd: {
        key: "upperAbd",
        label: "上腹 / 胃脘",
        symptoms: ["胃脘胀痛", "胃脘灼痛", "嗳气", "反酸", "纳呆", "口黏不渴", "口渴喜冷饮", "口渴不多饮"]
      },
      midAbd: {
        key: "midAbd",
        label: "中腹",
        symptoms: ["腹胀", "腹痛"]
      },
      lowerAbd: {
        key: "lowerAbd",
        label: "下腹 / 小腹 / 月经",
        symptoms: [
          "小腹坠胀",
          "小腹冷痛",
          "经行腹痛",
          "经量少",
          "经色紫暗有块"
        ]
      },
      stool: {
        key: "stool",
        label: "大便",
        symptoms: ["便溏", "大便干结"]
      },
      urine: {
        key: "urine",
        label: "小便",
        symptoms: ["小便短赤", "小便清长"]
      },
      whole: {
        key: "whole",
        label: "全身 / 体质",
        symptoms: [
          "乏力",
          "神疲懒言",
          "自汗",
          "盗汗",
          "畏寒肢冷",
          "手足心热",
          "面色少华",
          "面色潮红",
          "四肢沉重",
          "肢体麻木",
          "水肿",
          "易怒",
          "烦躁"
        ]
      }
    };

    // 当前选中的部位 key
    let currentRegionKey = "head";

    // 所有已选症状：[{regionKey, regionLabel, symptom}]
    let selectedSymptoms = [];

    const regionButtonsEl = document.getElementById("regionButtons");
    const symptomListEl = document.getElementById("symptomList");
    const selectedSummaryEl = document.getElementById("selectedSummary");
    const currentRegionTitleEl = document.getElementById("currentRegionTitle");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const analysisResultEl = document.getElementById("analysisResult");

    // ===== 渲染部位按钮 =====
    function renderRegionButtons() {
      regionButtonsEl.innerHTML = "";
      Object.values(BODY_REGIONS).forEach((region) => {
        const btn = document.createElement("button");
        btn.className = "region-btn" + (region.key === currentRegionKey ? " active" : "");
        btn.textContent = region.label;
        btn.onclick = () => {
          currentRegionKey = region.key;
          renderRegionButtons();
          renderSymptomList();
          updateCurrentRegionTitle();
        };
        regionButtonsEl.appendChild(btn);
      });
    }

    function updateCurrentRegionTitle() {
      const region = BODY_REGIONS[currentRegionKey];
      currentRegionTitleEl.textContent = `当前部位：${region.label}（可多选症状）`;
    }

    // 检查某个症状是否已经被选中
    function isSymptomSelected(regionKey, symptom) {
      return selectedSymptoms.some(
        (item) => item.regionKey === regionKey && item.symptom === symptom
      );
    }

    // 切换选中/取消
    function toggleSymptom(regionKey, symptom) {
      const region = BODY_REGIONS[regionKey];
      const idx = selectedSymptoms.findIndex(
        (item) => item.regionKey === regionKey && item.symptom === symptom
      );
      if (idx >= 0) {
        selectedSymptoms.splice(idx, 1);
      } else {
        selectedSymptoms.push({
          regionKey,
          regionLabel: region.label,
          symptom
        });
      }
      renderSymptomList();
      renderSelectedSummary();
    }

    // 渲染当前部位的症状列表（多选）
    function renderSymptomList() {
      const region = BODY_REGIONS[currentRegionKey];
      symptomListEl.innerHTML = "";
      const label = document.createElement("div");
      label.textContent = `${region.label}相关症状（可多选）：`;
      label.style.fontSize = "0.9rem";
      label.style.marginBottom = "4px";
      symptomListEl.appendChild(label);

      const container = document.createElement("div");
      container.className = "symptom-tags";

      region.symptoms.forEach((symptom) => {
        const tag = document.createElement("button");
        tag.type = "button";
        tag.className =
          "symptom-tag" +
          (isSymptomSelected(region.key, symptom) ? " selected" : "");
        tag.textContent = symptom;
        tag.onclick = () => toggleSymptom(region.key, symptom);
        container.appendChild(tag);
      });

      symptomListEl.appendChild(container);
    }

    // 渲染“当前已选择症状”汇总
    function renderSelectedSummary() {
      if (!selectedSymptoms.length) {
        selectedSummaryEl.textContent = "暂未选择任何症状。";
        return;
      }

      // 按部位分组
      const byRegion = {};
      selectedSymptoms.forEach((item) => {
        if (!byRegion[item.regionLabel]) {
          byRegion[item.regionLabel] = [];
        }
        byRegion[item.regionLabel].push(item.symptom);
      });

      const lines = [];
      Object.keys(byRegion).forEach((label) => {
        const list = Array.from(new Set(byRegion[label]));
        lines.push(`${label}：${list.join("、")}`);
      });

      selectedSummaryEl.innerHTML = lines
        .map((line) => `<div class="summary-item">${line}</div>`)
        .join("");
    }

    // 渲染返回结果
    function renderAnalysisResult(r) {
      if (!analysisResultEl) return;
      if (!r) {
        analysisResultEl.textContent =
          "请选择多个症状后，点击“生成辨证建议”查看示意性分析。";
        return;
      }

      let html = "";

      if (r.title) {
        html += `<div class="result-title">${r.title}</div>`;
      }
      if (r.pattern) {
        html += `<div class="result-section"><span class="result-label">可能相关证素方向（示意）：</span>${r.pattern}</div>`;
      }
      if (r.explanation) {
        html += `<div class="result-section"><span class="result-label">系统辨证思路：</span>${r.explanation}</div>`;
      }
      if (r.principle) {
        html += `<div class="result-section"><span class="result-label">治法思路（学习用）：</span>${r.principle}</div>`;
      }
      if (r.acupuncture) {
        html += `<div class="result-section"><span class="result-label">针灸取穴思路：</span>${r.acupuncture}</div>`;
      }
      if (r.herbal) {
        html += `<div class="result-section"><span class="result-label">中药方药思路：</span>${r.herbal}</div>`;
      }

      if (r.aiNotes) {
        html += `<div class="ai-note"><span class="result-label">中医师口吻解释（AI）：</span>${r.aiNotes}</div>`;
      }

      if (r.aiError) {
        html += `<div class="ai-error"><span class="result-label">AI 提示：</span>${r.aiError}</div>`;
      }

      if (r.warning) {
        html += `<div class="result-warning">${r.warning}</div>`;
      }

      analysisResultEl.innerHTML = html;
    }

    // 点击 “生成辨证建议”
    async function handleAnalyze() {
      if (!selectedSymptoms.length) {
        alert("请至少选择 2 条症状再生成辨证建议。");
        return;
      }
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = "正在向后端请求…";

      try {
        const payload = {
          symptoms: selectedSymptoms.map((s) => ({
            region: s.regionLabel,
            symptom: s.symptom
          }))
        };

        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const text = await resp.text();
          renderAnalysisResult({
            title: "请求失败",
            explanation: "后端返回了错误状态码，请检查接口是否可用。",
            warning: `HTTP 状态：${resp.status}，返回内容：${text}`
          });
        } else {
          const data = await resp.json();
          renderAnalysisResult(data);
        }
      } catch (err) {
        renderAnalysisResult({
          title: "请求失败",
          explanation: "与后端通信出错，请稍后重试或检查接口地址是否正确。",
          warning: `错误信息：${err && err.message ? err.message : String(
            err
          )}`
        });
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = "生成辨证建议（从后端）";
      }
    }

    analyzeBtn.addEventListener("click", handleAnalyze);

    // 初始化
    renderRegionButtons();
    updateCurrentRegionTitle();
    renderSymptomList();
    renderSelectedSummary();
    renderAnalysisResult(null);
  </script>
</body>
</html>



