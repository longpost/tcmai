<script>
  // ===== 0) 后端 API 地址 =====
  const API_URL = "https://tcmai-api.vercel.app/api/analyze";

  // ===== 1) i18n 文案（所有 UI 字都从这里出）=====
  const UI_TEXT = {
    zh: {
      titleRegion: "部位选择",
      titleSymptoms: "症状多选（按部位）",
      currentRegion: "当前部位：",
      selected: "当前已选择症状：",
      noneSelected: "暂未选择任何症状。",
      analyze: "生成辨证建议（从后端）",
      analyzing: "正在向后端请求…",
      resultTitle: "辨证结果示意",
      resultHint: "请选择多个症状后，点击“生成辨证建议”查看示意性分析。",
      need2: "请至少选择 2 条症状再生成辨证建议。",
      tip: "温馨提示：此工具仅用于中医理论学习和示意，不用于真实诊断或处方。",
      aiLabel: "中医师口吻解释（AI）：",
      aiError: "AI 提示：",
      warn: "请求失败"
    },
    en: {
      titleRegion: "Region",
      titleSymptoms: "Symptoms (by region)",
      currentRegion: "Current region: ",
      selected: "Selected symptoms:",
      noneSelected: "None selected.",
      analyze: "Analyze (from backend)",
      analyzing: "Requesting backend…",
      resultTitle: "Result (educational)",
      resultHint: "Select multiple symptoms, then click Analyze to see an educational summary.",
      need2: "Please select at least 2 symptoms.",
      tip: "Note: this tool is for educational TCM discussion only, not diagnosis or prescription.",
      aiLabel: "AI (clinician-style explanation):",
      aiError: "AI message:",
      warn: "Request failed"
    }
  };

  // ===== 2) 症状表：唯一数据源（带 zh/en + regions）=====
  // 你要加症状，只需要在这里追加一行；不会再出现“咽喉混进头痛、重复两次头痛”这种事故。
  const SYMPTOMS = [
    // 头部
    { zh: "头晕", en: "Dizziness", regions: ["head"] },
    { zh: "头痛", en: "Headache", regions: ["head"] },
    { zh: "偏头痛", en: "Migraine", regions: ["head"] },
    { zh: "头重如裹", en: "Heavy head sensation", regions: ["head"] },

    // 五官：眼/耳/鼻/咽喉/口腔（你之前说要加五官，先按这个结构分开）
    { zh: "目赤", en: "Red eyes", regions: ["eye"] },
    { zh: "目干", en: "Dry eyes", regions: ["eye"] },
    { zh: "视物模糊", en: "Blurred vision", regions: ["eye"] },
    { zh: "眼痒", en: "Itchy eyes", regions: ["eye"] },

    { zh: "耳鸣", en: "Tinnitus", regions: ["ear"] },
    { zh: "耳闷", en: "Ear fullness", regions: ["ear"] },
    { zh: "听力下降", en: "Hearing loss", regions: ["ear"] },

    { zh: "鼻塞", en: "Nasal congestion", regions: ["nose"] },
    { zh: "流清涕", en: "Clear nasal discharge", regions: ["nose"] },
    { zh: "流黄涕", en: "Yellow nasal discharge", regions: ["nose"] },
    { zh: "喷嚏", en: "Sneezing", regions: ["nose"] },

    { zh: "咽痛", en: "Sore throat", regions: ["throat"] },
    { zh: "咽干", en: "Dry throat", regions: ["throat"] },
    { zh: "咽痒", en: "Itchy throat", regions: ["throat"] },
    { zh: "咽中异物感", en: "Globus sensation", regions: ["throat"] },
    { zh: "声音嘶哑", en: "Hoarseness", regions: ["throat"] },

    { zh: "口干", en: "Dry mouth", regions: ["mouth"] },
    { zh: "口苦", en: "Bitter taste", regions: ["mouth"] },
    { zh: "口臭", en: "Bad breath", regions: ["mouth"] },
    { zh: "口黏不渴", en: "Sticky mouth without thirst", regions: ["mouth"] },
    { zh: "口渴喜冷饮", en: "Thirst for cold drinks", regions: ["mouth"] },
    { zh: "口渴不多饮", en: "Thirst but drinks little", regions: ["mouth"] },

    // 胸部
    { zh: "胸闷", en: "Chest oppression", regions: ["chest"] },
    { zh: "心悸", en: "Palpitations", regions: ["chest"] },
    { zh: "气短懒言", en: "Shortness of breath / low voice", regions: ["chest"] },
    { zh: "咳嗽", en: "Cough", regions: ["chest"] },
    { zh: "痰多", en: "Phlegm (copious)", regions: ["chest"] },
    { zh: "痰黄黏", en: "Yellow sticky phlegm", regions: ["chest"] },
    { zh: "痰白清稀", en: "Clear watery phlegm", regions: ["chest"] },
    { zh: "胸痛", en: "Chest pain", regions: ["chest"] },

    // 上腹
    { zh: "胃脘胀痛", en: "Epigastric distension/pain", regions: ["upperAbd"] },
    { zh: "胃脘灼痛", en: "Epigastric burning pain", regions: ["upperAbd"] },
    { zh: "嗳气", en: "Belching", regions: ["upperAbd"] },
    { zh: "反酸", en: "Acid reflux", regions: ["upperAbd"] },
    { zh: "纳呆", en: "Poor appetite", regions: ["upperAbd"] },

    // 中腹
    { zh: "腹胀", en: "Abdominal bloating", regions: ["midAbd"] },
    { zh: "腹痛", en: "Abdominal pain", regions: ["midAbd"] },

    // 下腹/经
    { zh: "小腹坠胀", en: "Lower abdominal heaviness", regions: ["lowerAbd"] },
    { zh: "小腹冷痛", en: "Cold pain in lower abdomen", regions: ["lowerAbd"] },
    { zh: "经行腹痛", en: "Menstrual abdominal pain", regions: ["lowerAbd"] },
    { zh: "经量少", en: "Scanty menstruation", regions: ["lowerAbd"] },
    { zh: "经色紫暗有块", en: "Dark-purple menses with clots", regions: ["lowerAbd"] },

    // 大便
    { zh: "便溏", en: "Loose stool", regions: ["stool"] },
    { zh: "大便干结", en: "Dry constipation", regions: ["stool"] },

    // 小便
    { zh: "小便短赤", en: "Dark scanty urine", regions: ["urine"] },
    { zh: "小便清长", en: "Clear copious urine", regions: ["urine"] },

    // 全身/体质
    { zh: "乏力", en: "Fatigue", regions: ["whole"] },
    { zh: "神疲懒言", en: "Lassitude / low speech", regions: ["whole"] },
    { zh: "自汗", en: "Spontaneous sweating", regions: ["whole"] },
    { zh: "盗汗", en: "Night sweating", regions: ["whole"] },
    { zh: "畏寒肢冷", en: "Aversion to cold / cold limbs", regions: ["whole"] },
    { zh: "手足心热", en: "Heat in palms/soles", regions: ["whole"] },
    { zh: "面色少华", en: "Pale complexion", regions: ["whole"] },
    { zh: "面色潮红", en: "Flushed complexion", regions: ["whole"] },
    { zh: "四肢沉重", en: "Heavy limbs", regions: ["whole"] },
    { zh: "肢体麻木", en: "Numbness", regions: ["whole"] },
    { zh: "水肿", en: "Edema", regions: ["whole"] },
    { zh: "易怒", en: "Irritability", regions: ["whole"] },
    { zh: "烦躁", en: "Restlessness", regions: ["whole"] }
  ];

  // ===== 3) 部位定义（按钮顺序/标签）=====
  // 只维护“部位本身”，不再维护症状数组
  const REGION_META = [
    { key: "head", zh: "头部", en: "Head" },
    { key: "eye", zh: "眼", en: "Eyes" },
    { key: "ear", zh: "耳", en: "Ears" },
    { key: "nose", zh: "鼻", en: "Nose" },
    { key: "throat", zh: "咽喉", en: "Throat" },
    { key: "mouth", zh: "口腔/口渴", en: "Mouth/Thirst" },
    { key: "chest", zh: "胸部 / 心肺", en: "Chest" },
    { key: "upperAbd", zh: "上腹 / 胃脘", en: "Upper abdomen" },
    { key: "midAbd", zh: "中腹", en: "Mid abdomen" },
    { key: "lowerAbd", zh: "下腹 / 月经", en: "Lower abdomen / Menses" },
    { key: "stool", zh: "大便", en: "Stool" },
    { key: "urine", zh: "小便", en: "Urine" },
    { key: "whole", zh: "全身 / 体质", en: "Whole body" }
  ];

  // ===== 4) 状态 =====
  let lang = "zh"; // 'zh' | 'en'
  let currentRegionKey = "head";
  let selectedSymptoms = []; // [{regionKey, symptomZh}]

  // ===== 5) DOM =====
  const regionButtonsEl = document.getElementById("regionButtons");
  const symptomListEl = document.getElementById("symptomList");
  const selectedSummaryEl = document.getElementById("selectedSummary");
  const currentRegionTitleEl = document.getElementById("currentRegionTitle");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const analysisResultEl = document.getElementById("analysisResult");

  // 语言切换按钮（插在左侧卡片标题下面）
  (function mountLangToggle() {
    const wrap = document.querySelector(".body-wrapper");
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "8px";
    row.style.marginBottom = "6px";

    const zhBtn = document.createElement("button");
    const enBtn = document.createElement("button");

    const styleBtn = (b) => {
      b.className = "region-btn";
      b.style.padding = "4px 12px";
    };

    styleBtn(zhBtn);
    styleBtn(enBtn);

    zhBtn.onclick = () => { lang = "zh"; rerenderAll(); };
    enBtn.onclick = () => { lang = "en"; rerenderAll(); };

    row.appendChild(zhBtn);
    row.appendChild(enBtn);
    wrap.insertBefore(row, wrap.children[1]); // 标题后面插入

    window.__langButtons = { zhBtn, enBtn };
  })();

  // ===== 6) 工具函数 =====
  function t(key) { return UI_TEXT[lang][key]; }

  function regionLabel(key) {
    const r = REGION_META.find(x => x.key === key);
    return r ? (lang === "zh" ? r.zh : r.en) : key;
  }

  function symptomsForRegion(key) {
    // 自动从 SYMPTOMS 过滤并去重（不会再出现“两种头痛”）
    const list = SYMPTOMS.filter(s => (s.regions || []).includes(key));
    const seen = new Set();
    const out = [];
    for (const s of list) {
      const k = s.zh; // 用中文名作为唯一ID（跟后端规则库一致）
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(s);
    }
    return out;
  }

  function isSelected(regionKey, symptomZh) {
    return selectedSymptoms.some(x => x.regionKey === regionKey && x.symptomZh === symptomZh);
  }

  function toggleSymptom(regionKey, symptomZh) {
    const idx = selectedSymptoms.findIndex(x => x.regionKey === regionKey && x.symptomZh === symptomZh);
    if (idx >= 0) selectedSymptoms.splice(idx, 1);
    else selectedSymptoms.push({ regionKey, symptomZh });
    renderSymptomList();
    renderSelectedSummary();
  }

  // ===== 7) 渲染 =====
  function renderRegionButtons() {
    regionButtonsEl.innerHTML = "";
    for (const r of REGION_META) {
      const btn = document.createElement("button");
      btn.className = "region-btn" + (r.key === currentRegionKey ? " active" : "");
      btn.textContent = lang === "zh" ? r.zh : r.en;
      btn.onclick = () => selectRegion(r.key);
      regionButtonsEl.appendChild(btn);
    }

    // 更新语言按钮状态
    const { zhBtn, enBtn } = window.__langButtons || {};
    if (zhBtn && enBtn) {
      zhBtn.textContent = "中文";
      enBtn.textContent = "English";
      zhBtn.classList.toggle("active", lang === "zh");
      enBtn.classList.toggle("active", lang === "en");
    }

    // 标题
    const h1s = document.querySelectorAll(".body-wrapper h1");
    if (h1s[0]) h1s[0].textContent = t("titleRegion");
    const rightCardTitle = document.querySelector(".right-wrapper .card h1");
    if (rightCardTitle) rightCardTitle.textContent = t("titleSymptoms");
    const resultH2 = document.querySelector(".right-wrapper .card + .card h2");
    if (resultH2) resultH2.textContent = t("resultTitle");
    analyzeBtn.textContent = t("analyze");
  }

  function updateCurrentRegionTitle() {
    currentRegionTitleEl.textContent = `${t("currentRegion")}${regionLabel(currentRegionKey)} (${lang === "zh" ? "可多选" : "multi-select"})`;
  }

  function renderSymptomList() {
    const list = symptomsForRegion(currentRegionKey);
    symptomListEl.innerHTML = "";

    const container = document.createElement("div");
    container.className = "symptom-tags";

    for (const s of list) {
      const tag = document.createElement("button");
      tag.type = "button";
      tag.className = "symptom-tag" + (isSelected(currentRegionKey, s.zh) ? " selected" : "");
      tag.textContent = lang === "zh" ? s.zh : s.en;
      tag.onclick = () => toggleSymptom(currentRegionKey, s.zh);
      container.appendChild(tag);
    }

    symptomListEl.appendChild(container);
  }

  function renderSelectedSummary() {
    if (!selectedSymptoms.length) {
      selectedSummaryEl.textContent = t("noneSelected");
      return;
    }
    const byRegion = {};
    for (const item of selectedSymptoms) {
      const label = regionLabel(item.regionKey);
      if (!byRegion[label]) byRegion[label] = [];
      const s = SYMPTOMS.find(x => x.zh === item.symptomZh);
      byRegion[label].push(lang === "zh" ? item.symptomZh : (s ? s.en : item.symptomZh));
    }
    const lines = Object.keys(byRegion).map(label => {
      const uniq = Array.from(new Set(byRegion[label]));
      return `${label}: ${uniq.join(lang === "zh" ? "、" : ", ")}`;
    });
    selectedSummaryEl.innerHTML = lines.map(line => `<div class="summary-item">${line}</div>`).join("");
  }

  function renderAnalysisResult(r) {
    if (!r) {
      analysisResultEl.textContent = t("resultHint");
      return;
    }
    let html = "";

    if (r.title) html += `<div class="result-title">${r.title}</div>`;
    if (r.pattern) html += `<div class="result-section"><span class="result-label">Pattern:</span> ${r.pattern}</div>`;
    if (r.explanation) html += `<div class="result-section"><span class="result-label">Explanation:</span> ${r.explanation}</div>`;
    if (r.principle) html += `<div class="result-section"><span class="result-label">Principle:</span> ${r.principle}</div>`;
    if (r.acupuncture) html += `<div class="result-section"><span class="result-label">Acupuncture:</span> ${r.acupuncture}</div>`;
    if (r.herbal) html += `<div class="result-section"><span class="result-label">Herbal:</span> ${r.herbal}</div>`;

    if (r.aiNotes) html += `<div class="ai-note"><span class="result-label">${t("aiLabel")}</span> ${r.aiNotes}</div>`;
    if (r.aiError) html += `<div class="ai-error"><span class="result-label">${t("aiError")}</span> ${r.aiError}</div>`;
    if (r.warning) html += `<div class="result-warning">${r.warning}</div>`;

    analysisResultEl.innerHTML = html;
  }

  function selectRegion(key) {
    currentRegionKey = key;
    renderRegionButtons();
    updateCurrentRegionTitle();
    renderSymptomList();
  }
  window.selectRegion = selectRegion; // 给 SVG onclick 用

  async function handleAnalyze() {
    if (selectedSymptoms.length < 2) {
      alert(t("need2"));
      return;
    }

    analyzeBtn.disabled = true;
    analyzeBtn.textContent = t("analyzing");

    try {
      const payload = {
        // 后端目前用 symptom 字段匹配；region 只是留给你调试展示
        symptoms: selectedSymptoms.map(s => ({
          region: regionLabel(s.regionKey),
          symptom: s.symptomZh
        })),
        // 可选：给后端用（如果你愿意后端也跟着输出英文）
        lang
      };

      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const text = await resp.text();
        renderAnalysisResult({
          title: t("warn"),
          explanation: `HTTP ${resp.status}`,
          warning: text
        });
      } else {
        const data = await resp.json();
        renderAnalysisResult(data);
      }
    } catch (err) {
      renderAnalysisResult({
        title: t("warn"),
        explanation: err?.message || String(err)
      });
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = t("analyze");
    }
  }

  analyzeBtn.addEventListener("click", handleAnalyze);

  function rerenderAll() {
    renderRegionButtons();
    updateCurrentRegionTitle();
    renderSymptomList();
    renderSelectedSummary();
    renderAnalysisResult(null);
    // 右侧提示语（你原来的 tip 文字如果是写死的，也建议你手动替换为 t("tip")）
  }

  // ===== 8) 初始化 =====
  rerenderAll();
  selectRegion("head");
</script>


