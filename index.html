<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>TCM Self-check (Educational)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --accent: #0077b6;
      --accent-soft: rgba(0, 119, 182, 0.08);
      --danger: #b00020;
      --text-main: #222222;
      --text-secondary: #555555;
      --tag-bg: #f0f0f3;
      --tag-selected-bg: #0077b6;
      --tag-selected-text: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #ffffff, var(--bg));
      color: var(--text-main);
      display: flex;
      flex-direction: row;
      gap: 16px;
      min-height: 100vh;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
      padding: 16px 18px;
    }

    .body-wrapper {
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .right-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    h1 { font-size: 1.15rem; margin: 0 0 4px; }
    h2 { font-size: 1rem; margin: 0 0 8px; }

    .row {
      width: 100%;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .body-region-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      width: 100%;
    }

    .region-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #fafafa;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s ease;
      user-select: none;
    }

    .region-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .symptom-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .symptom-tag {
      font-size: 0.82rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tag-bg);
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
      transition: all 0.12s ease;
      white-space: nowrap;
    }

    .symptom-tag.selected {
      border-color: var(--accent);
      background: var(--tag-selected-bg);
      color: var(--tag-selected-text);
      font-weight: 500;
    }

    .summary-box {
      font-size: 0.86rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .summary-title { font-weight: 600; margin-bottom: 4px; }
    .summary-item { margin-bottom: 2px; }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.06s ease;
      box-shadow: 0 4px 10px rgba(0, 119, 182, 0.25);
    }

    .btn-primary:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(0,119,182,0.25); }
    .btn-primary:disabled { opacity: 0.6; cursor: wait; box-shadow: none; }

    .hint {
      font-size: 0.78rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .result-box {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--text-main);
    }

    .result-title { font-weight: 600; margin-bottom: 4px; }
    .result-section { margin-top: 6px; }
    .result-label { font-weight: 600; }
    .result-warning { margin-top: 8px; color: var(--danger); }

    .ai-note {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #ddd;
      font-size: 0.88rem;
      color: #333333;
    }
    .ai-error { margin-top: 6px; color: var(--danger); font-size: 0.85rem; }

    .small {
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .pill {
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fafafa;
    }

    @media (max-width: 900px) {
      body { flex-direction: column; }
      .body-wrapper { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="body-wrapper card">
    <h1 id="titleRegion">部位选择</h1>

    <div class="row" style="justify-content:center; margin-bottom:4px;">
      <button id="btnZh" class="region-btn active" type="button">中文</button>
      <button id="btnEn" class="region-btn" type="button">English</button>
    </div>

    <div class="body-region-buttons" id="regionButtons"></div>

    <div class="hint" id="hintLeft">
      提示：点击部位按钮切换部位，再多选症状。
    </div>
  </div>

  <div class="right-wrapper">
    <div class="card">
      <h1 id="titleSymptoms">症状多选（按部位）</h1>

      <div id="currentRegionTitle" style="font-size:0.92rem;margin-bottom:4px;">
        当前部位：
      </div>

      <div id="symptomList"></div>

      <div class="summary-box" style="margin-top:10px;">
        <div class="summary-title" id="titleSelected">当前已选择症状：</div>
        <div id="selectedSummary">暂未选择任何症状。</div>
        <div class="small" style="margin-top:6px;">
          <span class="pill" id="selectedCount">已选：0</span>
          <span class="pill" id="apiInfo">API: -</span>
        </div>
      </div>

      <button id="analyzeBtn" class="btn-primary">生成辨证建议（从后端）</button>

      <div class="hint" id="tipRight">
        温馨提示：此工具仅用于中医理论学习和示意，不用于真实诊断或处方。
      </div>

      <details style="margin-top:10px;">
        <summary class="small" id="debugTitle">调试：查看发送给后端的 payload</summary>
        <pre id="debugPayload" style="white-space:pre-wrap; font-size:12px; color:#333;"></pre>
      </details>
    </div>

    <div class="card">
      <h2 id="titleResult">辨证结果示意</h2>
      <div id="analysisResult" class="result-box">
        请选择多个症状后，点击“生成辨证建议”查看示意性分析。
      </div>
    </div>

    <div class="card" id="eightCard" style="display:none;">
      <h2 id="titleEight">八纲/八证（前端粗判）</h2>
      <div class="result-box" id="eightBox"></div>
    </div>
  </div>

 <script>
  // ===== 0) API 配置 =====
  const ANALYZE_URL = "https://tcmai-api.vercel.app/api/analyze";
  const SYMPTOMS_URL = "https://tcmai-api.vercel.app/api/symptoms";

  // ===== 1) Region 定义（按钮永远靠这个显示）=====
  const REGION_META = [
    { key: "head", zh: "头部", en: "Head" },
    { key: "eye", zh: "眼", en: "Eyes" },
    { key: "ear", zh: "耳", en: "Ears" },
    { key: "nose", zh: "鼻", en: "Nose" },
    { key: "throat", zh: "咽喉", en: "Throat" },
    { key: "mouth", zh: "口腔/口渴", en: "Mouth/Thirst" },
    { key: "chest", zh: "胸部 / 心肺", en: "Chest" },
    { key: "upperAbd", zh: "上腹 / 胃脘", en: "Upper abdomen" },
    { key: "midAbd", zh: "中腹", en: "Mid abdomen" },
    { key: "lowerAbd", zh: "下腹 / 月经", en: "Lower abdomen / Menses" },
    { key: "stool", zh: "大便", en: "Stool" },
    { key: "urine", zh: "小便", en: "Urine" },
    { key: "whole", zh: "全身 / 体质", en: "Whole body" }
  ];

  // ===== 2) 状态 =====
  let lang = "zh";
  let currentRegionKey = "head";
  let regionsData = {}; // 后端返回：{ [regionKey]: [{id,zh,en}] }
  let selected = [];    // [{ regionKey, id }]

  // ===== 3) DOM（必须都存在，否则直接 return）=====
  const regionButtonsEl = document.getElementById("regionButtons");
  const symptomListEl = document.getElementById("symptomList");
  const selectedSummaryEl = document.getElementById("selectedSummary");
  const currentRegionTitleEl = document.getElementById("currentRegionTitle");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const analysisResultEl = document.getElementById("analysisResult");

  if (!regionButtonsEl || !symptomListEl || !selectedSummaryEl || !currentRegionTitleEl || !analyzeBtn || !analysisResultEl) {
    console.error("Missing required DOM nodes. Check ids: regionButtons, symptomList, selectedSummary, currentRegionTitle, analyzeBtn, analysisResult");
  }

  // 给 SVG onclick 用（你 SVG 里有 onclick="selectRegion('head')" 的话必须暴露）
  window.selectRegion = selectRegion;

  function regionLabel(key) {
    const r = REGION_META.find(x => x.key === key);
    return r ? (lang === "zh" ? r.zh : r.en) : key;
  }

  function renderRegionButtons() {
    regionButtonsEl.innerHTML = "";
    for (const r of REGION_META) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "region-btn" + (r.key === currentRegionKey ? " active" : "");
      btn.textContent = lang === "zh" ? r.zh : r.en;
      btn.onclick = () => selectRegion(r.key);
      regionButtonsEl.appendChild(btn);
    }
  }

  function updateCurrentRegionTitle() {
    currentRegionTitleEl.textContent = `当前部位：${regionLabel(currentRegionKey)}（可多选）`;
    if (lang === "en") {
      currentRegionTitleEl.textContent = `Current region: ${regionLabel(currentRegionKey)} (multi-select)`;
    }
  }

  function getSymptomsForRegion(key) {
    const list = regionsData[key] || [];
    // 去重按 id
    const seen = new Set();
    const out = [];
    for (const s of list) {
      if (!s || !s.id) continue;
      if (seen.has(s.id)) continue;
      seen.add(s.id);
      out.push(s);
    }
    return out;
  }

  function isSelected(regionKey, id) {
    return selected.some(x => x.regionKey === regionKey && x.id === id);
  }

  function toggleSymptom(regionKey, s) {
    const id = s.id;
    const idx = selected.findIndex(x => x.regionKey === regionKey && x.id === id);
    if (idx >= 0) selected.splice(idx, 1);
    else selected.push({ regionKey, id });
    renderSymptomList();
    renderSelectedSummary();
  }

  function renderSymptomList() {
    symptomListEl.innerHTML = "";
    const list = getSymptomsForRegion(currentRegionKey);

    if (!list.length) {
      const div = document.createElement("div");
      div.className = "hint";
      div.textContent = lang === "zh"
        ? "这个部位暂时没有症状（可能是后端 /api/symptoms 未加载成功，或后端 SYMPTOMS 没给这个 region 配置）。"
        : "No symptoms for this region (backend /api/symptoms may have failed, or SYMPTOMS has no items for this region).";
      symptomListEl.appendChild(div);
      return;
    }

    const container = document.createElement("div");
    container.className = "symptom-tags";

    for (const s of list) {
      const tag = document.createElement("button");
      tag.type = "button";
      tag.className = "symptom-tag" + (isSelected(currentRegionKey, s.id) ? " selected" : "");
      tag.textContent = (lang === "zh" ? (s.zh || s.id) : (s.en || s.zh || s.id));
      tag.onclick = () => toggleSymptom(currentRegionKey, s);
      container.appendChild(tag);
    }
    symptomListEl.appendChild(container);
  }

  function renderSelectedSummary() {
    if (!selected.length) {
      selectedSummaryEl.textContent = lang === "zh" ? "暂未选择任何症状。" : "None selected.";
      return;
    }

    // 建一个 id->name 的索引（从 regionsData 扫出来）
    const byId = new Map();
    for (const rk of Object.keys(regionsData)) {
      for (const s of (regionsData[rk] || [])) if (s?.id) byId.set(s.id, s);
    }

    const byRegion = {};
    for (const item of selected) {
      const label = regionLabel(item.regionKey);
      if (!byRegion[label]) byRegion[label] = [];
      const s = byId.get(item.id);
      const name = lang === "zh" ? (s?.zh || item.id) : (s?.en || s?.zh || item.id);
      byRegion[label].push(name);
    }

    const lines = Object.keys(byRegion).map(label => {
      const uniq = Array.from(new Set(byRegion[label]));
      return `${label}: ${uniq.join(lang === "zh" ? "、" : ", ")}`;
    });

    selectedSummaryEl.innerHTML = lines.map(x => `<div class="summary-item">${x}</div>`).join("");
  }

  function renderAnalysisResult(r) {
    if (!r) {
      analysisResultEl.textContent = lang === "zh"
        ? "请选择多个症状后，点击“生成辨证建议”查看示意性分析。"
        : "Select multiple symptoms, then click Analyze to see an educational summary.";
      return;
    }
    let html = "";
    if (r.title) html += `<div class="result-title">${r.title}</div>`;
    if (r.pattern) html += `<div class="result-section"><span class="result-label">Pattern:</span> ${r.pattern}</div>`;
    if (r.explanation) html += `<div class="result-section"><span class="result-label">Explanation:</span> ${r.explanation}</div>`;
    if (r.principle) html += `<div class="result-section"><span class="result-label">Principle:</span> ${r.principle}</div>`;
    if (r.acupuncture) html += `<div class="result-section"><span class="result-label">Acupuncture:</span> ${r.acupuncture}</div>`;
    if (r.herbal) html += `<div class="result-section"><span class="result-label">Herbal:</span> ${r.herbal}</div>`;
    if (r.aiNotes) html += `<div class="ai-note"><span class="result-label">AI:</span> ${r.aiNotes}</div>`;
    if (r.aiError) html += `<div class="ai-error"><span class="result-label">AI:</span> ${r.aiError}</div>`;
    if (r.warning) html += `<div class="result-warning">${r.warning}</div>`;
    analysisResultEl.innerHTML = html;
  }

  function selectRegion(key) {
    currentRegionKey = key;
    renderRegionButtons();
    updateCurrentRegionTitle();
    renderSymptomList();
  }

  async function loadSymptomsSafe() {
    try {
      const resp = await fetch(`${SYMPTOMS_URL}?lang=${encodeURIComponent(lang)}`, { cache: "no-store" });
      // ★关键：就算不是 200，也不要让页面死
      if (!resp.ok) throw new Error(`symptoms api HTTP ${resp.status}`);
      const data = await resp.json();
      regionsData = data?.regions || {};
    } catch (e) {
      console.error("loadSymptoms failed:", e);
      regionsData = {}; // 保底为空，但页面继续可用
    }
  }

  async function handleAnalyze() {
    if (selected.length < 2) {
      alert(lang === "zh" ? "请至少选择 2 条症状再生成辨证建议。" : "Please select at least 2 symptoms.");
      return;
    }

    analyzeBtn.disabled = true;
    analyzeBtn.textContent = lang === "zh" ? "正在向后端请求…" : "Requesting backend…";

    try {
      const payload = {
        lang,
        symptoms: selected.map(x => ({ id: x.id })),
        context: {},
        tongue: {},
        pulse: {}
      };

      const resp = await fetch(ANALYZE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const text = await resp.text();
        renderAnalysisResult({ title: "Request failed", explanation: `HTTP ${resp.status}`, warning: text });
      } else {
        const data = await resp.json();
        renderAnalysisResult(data);
      }
    } catch (e) {
      renderAnalysisResult({ title: "Request failed", explanation: e?.message || String(e) });
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = lang === "zh" ? "生成辨证建议（从后端）" : "Analyze (from backend)";
    }
  }

  analyzeBtn.addEventListener("click", handleAnalyze);

  // ===== init：先渲染“部位”，再去拉症状（拉失败也不影响部位显示）=====
  (async function init() {
    renderRegionButtons();
    updateCurrentRegionTitle();
    renderAnalysisResult(null);
    renderSelectedSummary();
    // 再加载症状
    await loadSymptomsSafe();
    renderSymptomList();
  })();
</script>

</body>
</html>


