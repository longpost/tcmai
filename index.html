<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>TCM Self-check (Educational)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --accent: #0077b6;
      --accent-soft: rgba(0, 119, 182, 0.08);
      --danger: #b00020;
      --text-main: #222222;
      --text-secondary: #555555;
      --tag-bg: #f0f0f3;
      --tag-selected-bg: #0077b6;
      --tag-selected-text: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #ffffff, var(--bg));
      color: var(--text-main);
      display: flex;
      flex-direction: row;
      gap: 16px;
      min-height: 100vh;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
      padding: 16px 18px;
    }

    .body-wrapper {
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .right-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    h1 { font-size: 1.15rem; margin: 0 0 4px; }
    h2 { font-size: 1rem; margin: 0 0 8px; }

    .row {
      width: 100%;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .body-region-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      width: 100%;
    }

    .region-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #fafafa;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s ease;
      user-select: none;
    }

    .region-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .symptom-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .symptom-tag {
      font-size: 0.82rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tag-bg);
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
      transition: all 0.12s ease;
      white-space: nowrap;
    }

    .symptom-tag.selected {
      border-color: var(--accent);
      background: var(--tag-selected-bg);
      color: var(--tag-selected-text);
      font-weight: 500;
    }

    .summary-box {
      font-size: 0.86rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .summary-title { font-weight: 600; margin-bottom: 4px; }
    .summary-item { margin-bottom: 2px; }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.06s ease;
      box-shadow: 0 4px 10px rgba(0, 119, 182, 0.25);
    }

    .btn-primary:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(0,119,182,0.25); }
    .btn-primary:disabled { opacity: 0.6; cursor: wait; box-shadow: none; }

    .hint {
      font-size: 0.78rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .result-box {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--text-main);
    }

    .result-title { font-weight: 600; margin-bottom: 4px; }
    .result-section { margin-top: 6px; }
    .result-label { font-weight: 600; }
    .result-warning { margin-top: 8px; color: var(--danger); }

    .ai-note {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #ddd;
      font-size: 0.88rem;
      color: #333333;
    }
    .ai-error { margin-top: 6px; color: var(--danger); font-size: 0.85rem; }

    .small {
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .pill {
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fafafa;
    }

    @media (max-width: 900px) {
      body { flex-direction: column; }
      .body-wrapper { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="body-wrapper card">
    <h1 id="titleRegion">部位选择</h1>

    <div class="row" style="justify-content:center; margin-bottom:4px;">
      <button id="btnZh" class="region-btn active" type="button">中文</button>
      <button id="btnEn" class="region-btn" type="button">English</button>
    </div>

    <div class="body-region-buttons" id="regionButtons"></div>

    <div class="hint" id="hintLeft">
      提示：点击部位按钮切换部位，再多选症状。
    </div>
  </div>

  <div class="right-wrapper">
    <div class="card">
      <h1 id="titleSymptoms">症状多选（按部位）</h1>

      <div id="currentRegionTitle" style="font-size:0.92rem;margin-bottom:4px;">
        当前部位：
      </div>

      <div id="symptomList"></div>

      <div class="summary-box" style="margin-top:10px;">
        <div class="summary-title" id="titleSelected">当前已选择症状：</div>
        <div id="selectedSummary">暂未选择任何症状。</div>
        <div class="small" style="margin-top:6px;">
          <span class="pill" id="selectedCount">已选：0</span>
          <span class="pill" id="apiInfo">API: -</span>
        </div>
      </div>

      <button id="analyzeBtn" class="btn-primary">生成辨证建议（从后端）</button>

      <div class="hint" id="tipRight">
        温馨提示：此工具仅用于中医理论学习和示意，不用于真实诊断或处方。
      </div>

      <details style="margin-top:10px;">
        <summary class="small" id="debugTitle">调试：查看发送给后端的 payload</summary>
        <pre id="debugPayload" style="white-space:pre-wrap; font-size:12px; color:#333;"></pre>
      </details>
    </div>

    <div class="card">
      <h2 id="titleResult">辨证结果示意</h2>
      <div id="analysisResult" class="result-box">
        请选择多个症状后，点击“生成辨证建议”查看示意性分析。
      </div>
    </div>

    <div class="card" id="eightCard" style="display:none;">
      <h2 id="titleEight">八纲/八证（前端粗判）</h2>
      <div class="result-box" id="eightBox"></div>
    </div>
  </div>

  <script>
    // ===== 0) API 配置 =====
    const ANALYZE_URL = "https://tcmai-api.vercel.app/api/analyze";
    const SYMPTOMS_URL = "https://tcmai-api.vercel.app/api/symptoms";

    // ===== 1) i18n =====
    const UI_TEXT = {
      zh: {
        titleRegion: "部位选择",
        hintLeft: "提示：点击部位按钮切换部位，再多选症状。",
        titleSymptoms: "症状多选（按部位）",
        currentRegion: "当前部位：",
        titleSelected: "当前已选择症状：",
        noneSelected: "暂未选择任何症状。",
        analyze: "生成辨证建议（从后端）",
        analyzing: "正在向后端请求…",
        tipRight: "温馨提示：此工具仅用于中医理论学习和示意，不用于真实诊断或处方。",
        titleResult: "辨证结果示意",
        resultHint: "请选择多个症状后，点击“生成辨证建议”查看示意性分析。",
        need2: "请至少选择 2 条症状再生成辨证建议。",
        warn: "请求失败",
        debugTitle: "调试：查看发送给后端的 payload",
        titleEight: "八纲/八证（后端判定）",
        eightIntro: "这是用于自我复核的“粗筛”，不是诊断。"
      },
      en: {
        titleRegion: "Region",
        hintLeft: "Tip: switch regions, then multi-select symptoms.",
        titleSymptoms: "Symptoms (by region)",
        currentRegion: "Current region: ",
        titleSelected: "Selected symptoms:",
        noneSelected: "None selected.",
        analyze: "Analyze (from backend)",
        analyzing: "Requesting backend…",
        tipRight: "Note: educational TCM discussion only, not diagnosis or prescription.",
        titleResult: "Result (educational)",
        resultHint: "Select multiple symptoms, then click Analyze to see an educational summary.",
        need2: "Please select at least 2 symptoms.",
        warn: "Request failed",
        debugTitle: "Debug: payload sent to backend",
        titleEight: "Eight Principles (backend)",
        eightIntro: "This is a coarse self-check, not a diagnosis."
      }
    };

    // ===== 2) Region 定义（顺序 + 显示名）=====
    // 关键：这些 key 必须与你后端 SYMPTOMS[].regions 一致
    const REGION_META = [
      { key: "head", zh: "头部", en: "Head" },
      { key: "eye", zh: "眼", en: "Eyes" },
      { key: "ear", zh: "耳", en: "Ears" },
      { key: "nose", zh: "鼻", en: "Nose" },
      { key: "throat", zh: "咽喉", en: "Throat" },
      { key: "mouth", zh: "口腔/口渴", en: "Mouth/Thirst" },
      { key: "chest", zh: "胸部 / 心肺", en: "Chest" },
      { key: "upperAbd", zh: "上腹 / 胃脘", en: "Upper abdomen" },
      { key: "midAbd", zh: "中腹", en: "Mid abdomen" },
      { key: "lowerAbd", zh: "下腹 / 月经", en: "Lower abdomen / Menses" },
      { key: "stool", zh: "大便", en: "Stool" },
      { key: "urine", zh: "小便", en: "Urine" },
      { key: "whole", zh: "全身 / 体质", en: "Whole body" }
    ];

    // ===== 3) State =====
    let lang = "zh";
    let currentRegionKey = "head";

    // 后端返回：{ regions: { chest: [{id,zh,en}, ...], ... } }
    let regionsData = {}; // mapping: regionKey -> symptom[]
    // 已选：用 id（因为 analyze 后端只认 id）
    let selected = []; // [{ regionKey, id }]

    // ===== 4) DOM =====
    const regionButtonsEl = document.getElementById("regionButtons");
    const symptomListEl = document.getElementById("symptomList");
    const selectedSummaryEl = document.getElementById("selectedSummary");
    const currentRegionTitleEl = document.getElementById("currentRegionTitle");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const analysisResultEl = document.getElementById("analysisResult");
    const debugPayloadEl = document.getElementById("debugPayload");
    const eightCardEl = document.getElementById("eightCard");
    const eightBoxEl = document.getElementById("eightBox");

    const btnZh = document.getElementById("btnZh");
    const btnEn = document.getElementById("btnEn");

    function t(k) { return UI_TEXT[lang][k]; }

    function regionLabel(key) {
      const r = REGION_META.find(x => x.key === key);
      return r ? (lang === "zh" ? r.zh : r.en) : key;
    }

    function setTexts() {
      document.getElementById("titleRegion").textContent = t("titleRegion");
      document.getElementById("hintLeft").textContent = t("hintLeft");
      document.getElementById("titleSymptoms").textContent = t("titleSymptoms");
      document.getElementById("titleSelected").textContent = t("titleSelected");
      document.getElementById("tipRight").textContent = t("tipRight");
      document.getElementById("titleResult").textContent = t("titleResult");
      document.getElementById("debugTitle").textContent = t("debugTitle");
      document.getElementById("titleEight").textContent = t("titleEight");

      analyzeBtn.textContent = t("analyze");
      btnZh.classList.toggle("active", lang === "zh");
      btnEn.classList.toggle("active", lang === "en");
    }

    // ===== 5) Load symptom list from backend =====
    async function loadSymptoms() {
      const url = `${SYMPTOMS_URL}?lang=${encodeURIComponent(lang)}`;
      document.getElementById("apiInfo").textContent = `API: ${new URL(ANALYZE_URL).host}/api/analyze`;
      const resp = await fetch(url);
      const data = await resp.json();
      regionsData = (data && data.regions) ? data.regions : {};
    }

    // ===== 6) Render Regions =====
    function renderRegionButtons() {
      regionButtonsEl.innerHTML = "";
      for (const r of REGION_META) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "region-btn" + (r.key === currentRegionKey ? " active" : "");
        btn.textContent = lang === "zh" ? r.zh : r.en;

        // 如果后端这个 region 目前完全没有症状，也照样显示（你后续随时能加）
        btn.onclick = () => selectRegion(r.key);

        regionButtonsEl.appendChild(btn);
      }
    }

    function updateCurrentRegionTitle() {
      currentRegionTitleEl.textContent = `${t("currentRegion")}${regionLabel(currentRegionKey)} (${lang === "zh" ? "可多选" : "multi-select"})`;
    }

    // ===== 7) Render Symptoms =====
    function getSymptomsForCurrentRegion() {
      const list = regionsData[currentRegionKey] || [];
      // 去重（按 id）
      const seen = new Set();
      const out = [];
      for (const s of list) {
        if (!s || !s.id) continue;
        if (seen.has(s.id)) continue;
        seen.add(s.id);
        out.push(s);
      }
      return out;
    }

    function isSelected(regionKey, id) {
      return selected.some(x => x.regionKey === regionKey && x.id === id);
    }

    function toggleSymptom(regionKey, symptom) {
      const id = symptom.id;
      const idx = selected.findIndex(x => x.regionKey === regionKey && x.id === id);
      if (idx >= 0) selected.splice(idx, 1);
      else selected.push({ regionKey, id });
      renderSymptomList();
      renderSelectedSummary();
    }

    function renderSymptomList() {
      symptomListEl.innerHTML = "";

      const list = getSymptomsForCurrentRegion();

      if (!list.length) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = lang === "zh"
          ? "这个部位暂时没有症状（去后端 lib/data 里给这个 region 加一些 SYMPTOMS 即可）。"
          : "No symptoms yet for this region (add SYMPTOMS in backend lib/data).";
        symptomListEl.appendChild(empty);
        return;
      }

      const container = document.createElement("div");
      container.className = "symptom-tags";

      for (const s of list) {
        const tag = document.createElement("button");
        tag.type = "button";
        tag.className = "symptom-tag" + (isSelected(currentRegionKey, s.id) ? " selected" : "");
        tag.textContent = lang === "zh" ? (s.zh || s.id) : (s.en || s.zh || s.id);
        tag.onclick = () => toggleSymptom(currentRegionKey, s);
        container.appendChild(tag);
      }

      symptomListEl.appendChild(container);
    }

    function renderSelectedSummary() {
      const countEl = document.getElementById("selectedCount");
      countEl.textContent = (lang === "zh" ? "已选：" : "Selected: ") + selected.length;

      if (!selected.length) {
        selectedSummaryEl.textContent = t("noneSelected");
        return;
      }

      // build quick lookup: id -> {zh,en}
      const byId = new Map();
      for (const rk of Object.keys(regionsData)) {
        for (const s of (regionsData[rk] || [])) {
          if (s && s.id) byId.set(s.id, s);
        }
      }

      const byRegion = {};
      for (const item of selected) {
        const label = regionLabel(item.regionKey);
        if (!byRegion[label]) byRegion[label] = [];
        const s = byId.get(item.id);
        const name = lang === "zh" ? (s?.zh || item.id) : (s?.en || s?.zh || item.id);
        byRegion[label].push(name);
      }

      const lines = Object.keys(byRegion).map(label => {
        const uniq = Array.from(new Set(byRegion[label]));
        return `${label}: ${uniq.join(lang === "zh" ? "、" : ", ")}`;
      });

      selectedSummaryEl.innerHTML = lines.map(line => `<div class="summary-item">${line}</div>`).join("");
    }

    // ===== 8) Result rendering =====
    function renderAnalysisResult(r) {
      if (!r) {
        analysisResultEl.textContent = t("resultHint");
        return;
      }

      let html = "";
      if (r.title) html += `<div class="result-title">${r.title}</div>`;
      if (r.pattern) html += `<div class="result-section"><span class="result-label">${lang === "zh" ? "Pattern：" : "Pattern: "}</span>${r.pattern}</div>`;
      if (r.explanation) html += `<div class="result-section"><span class="result-label">${lang === "zh" ? "Explanation：" : "Explanation: "}</span>${r.explanation}</div>`;
      if (r.principle) html += `<div class="result-section"><span class="result-label">${lang === "zh" ? "Principle：" : "Principle: "}</span>${r.principle}</div>`;
      if (r.acupuncture) html += `<div class="result-section"><span class="result-label">${lang === "zh" ? "Acupuncture：" : "Acupuncture: "}</span>${r.acupuncture}</div>`;
      if (r.herbal) html += `<div class="result-section"><span class="result-label">${lang === "zh" ? "Herbal：" : "Herbal: "}</span>${r.herbal}</div>`;

      if (r.aiNotes) html += `<div class="ai-note"><span class="result-label">${lang === "zh" ? "AI：" : "AI: "}</span>${r.aiNotes}</div>`;
      if (r.aiError) html += `<div class="ai-error"><span class="result-label">${lang === "zh" ? "AI 提示：" : "AI message: "}</span>${r.aiError}</div>`;
      if (r.warning) html += `<div class="result-warning">${r.warning}</div>`;

      analysisResultEl.innerHTML = html;
    }

    function renderEightPrinciplesBlock(r) {
      // 后端 analyze.js 返回：eightPrinciples / eightEvidence
      if (!r || !r.eightPrinciples) {
        eightCardEl.style.display = "none";
        eightBoxEl.innerHTML = "";
        return;
      }

      const ep = r.eightPrinciples;
      const evidence = Array.isArray(r.eightEvidence) ? r.eightEvidence : [];

      const lines = [];
      lines.push(`<div class="small">${t("eightIntro")}</div>`);
      lines.push(`<div class="result-section"><span class="result-label">${lang === "zh" ? "表/里：" : "Exterior/Interior: "}</span>${ep.interiorExterior}</div>`);
      lines.push(`<div class="result-section"><span class="result-label">${lang === "zh" ? "寒/热：" : "Cold/Heat: "}</span>${ep.coldHeat}</div>`);
      lines.push(`<div class="result-section"><span class="result-label">${lang === "zh" ? "虚/实：" : "Def/Excess: "}</span>${ep.defExcess}</div>`);
      lines.push(`<div class="result-section"><span class="result-label">${lang === "zh" ? "阴/阳：" : "Yin/Yang: "}</span>${ep.yinYang}</div>`);

      if (evidence.length) {
        const ev = evidence.slice(0, 14).map(x => `• ${x}`).join("<br/>");
        lines.push(`<div class="result-section"><span class="result-label">${lang === "zh" ? "依据：" : "Evidence: "}</span><div class="small" style="margin-top:4px;">${ev}</div></div>`);
      }

      eightBoxEl.innerHTML = lines.join("");
      eightCardEl.style.display = "block";
    }

    // ===== 9) Actions =====
    function selectRegion(key) {
      currentRegionKey = key;
      renderRegionButtons();
      updateCurrentRegionTitle();
      renderSymptomList();
    }

    async function handleAnalyze() {
      if (selected.length < 2) {
        alert(t("need2"));
        return;
      }

      analyzeBtn.disabled = true;
      analyzeBtn.textContent = t("analyzing");

      try {
        const payload = {
          lang,
          symptoms: selected.map(x => ({ id: x.id })), // ★关键：只发 id，后端才会算
          // 你要的话还能加 context/tongue/pulse
          context: {},
          tongue: {},
          pulse: {}
        };

        debugPayloadEl.textContent = JSON.stringify(payload, null, 2);

        const resp = await fetch(ANALYZE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const text = await resp.text();
          renderAnalysisResult({
            title: t("warn"),
            explanation: `HTTP ${resp.status}`,
            warning: text
          });
          renderEightPrinciplesBlock(null);
        } else {
          const data = await resp.json();
          renderAnalysisResult(data);
          renderEightPrinciplesBlock(data);
        }
      } catch (err) {
        renderAnalysisResult({
          title: t("warn"),
          explanation: err?.message || String(err)
        });
        renderEightPrinciplesBlock(null);
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = t("analyze");
      }
    }

    analyzeBtn.addEventListener("click", handleAnalyze);

    // ===== 10) Language switching =====
    btnZh.onclick = async () => {
      lang = "zh";
      setTexts();
      await loadSymptoms();
      // 保留已选 id，不清空
      renderRegionButtons();
      updateCurrentRegionTitle();
      renderSymptomList();
      renderSelectedSummary();
      renderAnalysisResult(null);
      renderEightPrinciplesBlock(null);
    };

    btnEn.onclick = async () => {
      lang = "en";
      setTexts();
      await loadSymptoms();
      renderRegionButtons();
      updateCurrentRegionTitle();
      renderSymptomList();
      renderSelectedSummary();
      renderAnalysisResult(null);
      renderEightPrinciplesBlock(null);
    };

    // ===== init =====
    (async function init() {
      setTexts();
      await loadSymptoms();
      renderRegionButtons();
      updateCurrentRegionTitle();
      renderSymptomList();
      renderSelectedSummary();
      renderAnalysisResult(null);
      renderEightPrinciplesBlock(null);
      selectRegion("head");
    })();
  </script>
</body>
</html>


