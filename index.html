<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TCM Pattern Self-Check (Educational)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:0; background:#f6f7f9; }
    h1,h2 { margin:0 0 8px 0; }
    .wrap { display:flex; gap:16px; padding:16px; }
    .card { background:#fff; border-radius:8px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .left { width:260px; }
    .right { flex:1; display:flex; flex-direction:column; gap:12px; }
    button { cursor:pointer; }
    .region-btn { display:block; width:100%; margin-bottom:6px; padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fafafa; }
    .region-btn.active { background:#2563eb; color:#fff; border-color:#2563eb; }
    .tag { display:inline-block; margin:4px; padding:4px 8px; border-radius:999px; border:1px solid #aaa; background:#f3f3f3; }
    .tag.selected { background:#2563eb; color:#fff; border-color:#2563eb; }
    .muted { color:#666; font-size:13px; }
    pre { background:#111; color:#0f0; padding:8px; overflow:auto; font-size:12px; }
  </style>
</head>

<body>

<div class="wrap">

  <!-- LEFT -->
  <div class="card left">
    <h1 id="ui-region-title">Region</h1>

    <div style="margin-bottom:8px;">
      <button id="btn-zh">中文</button>
      <button id="btn-en">English</button>
    </div>

    <div id="regionButtons"></div>

    <div class="muted" style="margin-top:8px;">
      API: <span id="apiBase"></span>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">

    <div class="card">
      <h2 id="ui-selected-title">Selected</h2>
      <div id="selectedBox" class="muted">None selected.</div>
    </div>

    <div class="card">
      <h2 id="ui-symptom-title">Symptoms (by region)</h2>
      <div id="currentRegion" class="muted"></div>
      <div id="symptomList"></div>
    </div>

    <div class="card">
      <button id="analyzeBtn">Analyze (backend)</button>
      <div class="muted" id="tipText"></div>
    </div>

    <div class="card">
      <h2 id="ui-result-title">Result</h2>
      <div id="resultBox" class="muted">
        Select multiple symptoms and click Analyze.
      </div>
    </div>

    <div class="card">
      <h2>Debug</h2>
      <pre id="debugBox"></pre>
    </div>

  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://tcmai-api.vercel.app";
const API_SYMPTOMS = API_BASE + "/api/symptoms";
const API_ANALYZE  = API_BASE + "/api/analyze";

document.getElementById("apiBase").textContent = API_BASE;

/* ================= I18N ================= */
const TEXT = {
  zh: {
    region: "部位选择",
    selected: "已选症状",
    symptoms: "症状多选（按部位）",
    analyze: "生成辨证建议（从后端）",
    tip: "仅用于学习与自我复核，不作诊断处方。",
    none: "暂未选择任何症状。",
    current: "当前部位：",
    result: "辨证结果"
  },
  en: {
    region: "Region",
    selected: "Selected",
    symptoms: "Symptoms (by region)",
    analyze: "Analyze (backend)",
    tip: "Educational self-check only; not diagnosis or medical advice.",
    none: "None selected.",
    current: "Current region:",
    result: "Result"
  }
};

let lang = "en";

/* ================= STATE ================= */
let regions = {};        // from backend
let regionKeys = [];
let currentRegion = null;
let selected = [];       // [{id, zh, en}]

/* ================= HELPERS ================= */
function t(k){ return TEXT[lang][k]; }
function setText(){
  document.getElementById("ui-region-title").textContent = t("region");
  document.getElementById("ui-selected-title").textContent = t("selected");
  document.getElementById("ui-symptom-title").textContent = t("symptoms");
  document.getElementById("ui-result-title").textContent = t("result");
  document.getElementById("analyzeBtn").textContent = t("analyze");
  document.getElementById("tipText").textContent = t("tip");
}

/* ================= LOAD SYMPTOMS ================= */
async function loadSymptoms(){
  const url = API_SYMPTOMS + "?lang=" + lang;
  const resp = await fetch(url);
  if(!resp.ok) throw new Error("symptoms HTTP " + resp.status);
  const data = await resp.json();
  regions = data.regions || {};
  regionKeys = Object.keys(regions);
  currentRegion = regionKeys[0] || null;
}

/* ================= RENDER ================= */
function renderRegions(){
  const box = document.getElementById("regionButtons");
  box.innerHTML = "";
  regionKeys.forEach(k=>{
    const b = document.createElement("button");
    b.className = "region-btn" + (k===currentRegion?" active":"");
    b.textContent = k;
    b.onclick = ()=>{ currentRegion = k; renderRegions(); renderSymptoms(); };
    box.appendChild(b);
  });
}

function renderSymptoms(){
  const box = document.getElementById("symptomList");
  box.innerHTML = "";
  document.getElementById("currentRegion").textContent =
    t("current") + " " + currentRegion;

  const list = regions[currentRegion] || [];
  if(!list.length){
    box.innerHTML = "<div class='muted'>No symptoms for this region</div>";
    return;
  }
  list.forEach(s=>{
    const btn = document.createElement("button");
    const isSel = selected.some(x=>x.id===s.id);
    btn.className = "tag" + (isSel?" selected":"");
    btn.textContent = lang==="zh"?s.zh:s.en;
    btn.onclick = ()=>{
      if(isSel){
        selected = selected.filter(x=>x.id!==s.id);
      }else{
        selected.push(s);
      }
      renderSymptoms();
      renderSelected();
    };
    box.appendChild(btn);
  });
}

function renderSelected(){
  const box = document.getElementById("selectedBox");
  if(!selected.length){
    box.textContent = t("none");
    return;
  }
  box.innerHTML = selected.map(s =>
    `<span class="tag selected">${lang==="zh"?s.zh:s.en}</span>`
  ).join("");
}

/* ================= ANALYZE ================= */
async function analyze(){
  if(selected.length < 2){
    alert("Select at least 2 symptoms");
    return;
  }
  const payload = {
    lang,
    symptoms: selected.map(s=>({ id:s.id }))
  };
  document.getElementById("debugBox").textContent =
    JSON.stringify(payload,null,2);

  const resp = await fetch(API_ANALYZE,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const data = await resp.json();
  document.getElementById("resultBox").innerHTML =
    "<pre>"+JSON.stringify(data,null,2)+"</pre>";
}

/* ================= INIT ================= */
document.getElementById("btn-zh").onclick = async ()=>{
  lang="zh"; setText(); await init();
};
document.getElementById("btn-en").onclick = async ()=>{
  lang="en"; setText(); await init();
};
document.getElementById("analyzeBtn").onclick = analyze;

async function init(){
  await loadSymptoms();
  renderRegions();
  renderSymptoms();
  renderSelected();
}

setText();
init().catch(e=>{
  document.getElementById("resultBox").textContent = e.message;
});
</script>

</body>
</html>


